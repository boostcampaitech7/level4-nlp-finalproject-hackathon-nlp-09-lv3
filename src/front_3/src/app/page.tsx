"use client";

import { useState, useRef, Dispatch, SetStateAction } from "react";
import { useClosedQueryApi } from "./store/useClosedQueryApi";// API ÌõÖ ÏûÑÌè¨Ìä∏
import { useOpenQueryApi } from "./store/useOpenQueryApi";// API ÌõÖ ÏûÑÌè¨Ìä∏
//import { closedQueryClient } from "./store/closedQueryClient";// API ÌõÖ ÏûÑÌè¨Ìä∏
import { QueryClient, QueryClientProvider } from "@tanstack/react-query";
import ExampleList from "./components/ExampleList";
import SearchBar from "./components/SearchBar";
import ChatList from "./components/ChatList";
import ThemeToggle from "./components/ThemeToggle";
import ChatHistoryMenu from './components/ChatHistoryMenu';
import type { ChatHistory } from './types/chatHistory';
import { parseClosedApiResponse } from './api/parsers/chatParser';
import type { QAndA } from "./types/question";

export const closedQueryClient = new QueryClient();

function HomeContent() {
  const [questionList, setQuestionList] = useState<QAndA[]>([]);
  const [showExampleList, setShowExampleList] = useState(true);
  const [histories, setHistories] = useState<ChatHistory[]>([]);
  const [domain, setDomain] = useState<'open' | 'close' | null>(null);
  const [currentChatId, setCurrentChatId] = useState<string | null>(null);
  const [loadingIndex, setLoadingIndex] = useState<number | null>(null);
  
  const searchBarRef = useRef<{ setText: (text: string) => void } | null>(null);
  const abortControllerRef = useRef<AbortController | null>(null);
  const { mutate, isPending, mutateAsync }  = useClosedQueryApi(); // mutation Í∞ùÏ≤¥ ÏÇ¨Ïö©

  const handleExampleClick = (example: string) => {
    const formData = new FormData();
    formData.append('search', example);
    handleSubmit(formData);
  };

  const handleSubmit = async (formData: FormData) => {
    const submittedQuestion = formData.get("search") as string;
    
    if (!submittedQuestion?.trim()) return;

    const newQuestion = {
      question: submittedQuestion,
      answer: null,
    };

    let newId: string | null = null;

    if (!currentChatId) {
      newId = Date.now().toString();
      setCurrentChatId(newId);
      const newHistory: ChatHistory = {
        id: newId,
        title: submittedQuestion,
        messages: [newQuestion],
        createdAt: new Date(),
      };
      setHistories(prev => [newHistory, ...prev]);
      setQuestionList([newQuestion]);
    } else {
      const updatedQuestionList = [...questionList, newQuestion];
      setQuestionList(updatedQuestionList);
      updateCurrentChat(updatedQuestionList);
    }
    
    setShowExampleList(false);

    if (abortControllerRef.current) {
      abortControllerRef.current.abort();
    }

    abortControllerRef.current = new AbortController();

    //domainÏóê Îî∞Îùº Îã§Î•∏ api Î≥¥ÎÇ¥ÎèÑÎ°ù Î∞îÍøîÎ≥¥Í∏∞
    //null -> query, open -> open, close -> closed
    try {
      const result = await mutateAsync(submittedQuestion); // mutate Ìò∏Ï∂úÌïòÏó¨ API ÏöîÏ≤≠
      console.log("API ÏùëÎãµ Í≤∞Í≥º:", result);

      // üîπ API ÏùëÎãµÏùÑ parseClosedApiResponseÎ°ú Î≥ÄÌôò
      const parsedResponse = parseClosedApiResponse(result, submittedQuestion);

      const updatedQuestion = {
        ...newQuestion,
        answer: parsedResponse.answer,
        error: false,
        imageName: parsedResponse.imageName, // Ïù¥ÎØ∏ÏßÄ Ï†ïÎ≥¥
        fileNames: parsedResponse.fileNames,  // PDF Ï†ïÎ≥¥
        audioFileName: parsedResponse.audioFileName // TTS Ïò§ÎîîÏò§ ÌååÏùº Ï†ïÎ≥¥
      };

      const updatedList = questionList.length > 0 
        ? [...questionList, updatedQuestion]
        : [updatedQuestion];

        setQuestionList(prev => [...prev, updatedQuestion]);
        console.log("ÏóÖÎç∞Ïù¥Ìä∏Îêú questionList:", [...questionList, updatedQuestion]);
      
      // ÌòÑÏû¨ ÎåÄÌôî ÎòêÎäî ÏÉà ÎåÄÌôî ÏóÖÎç∞Ïù¥Ìä∏
      if (currentChatId) {
        updateCurrentChat([...questionList, updatedQuestion]);
      } else if (newId) {
        setHistories(prev => prev.map(history => 
          history.id === newId
            ? { ...history, messages: updatedList }
            : history
        ));
      }
    } catch (error) {
      console.error("API ÏöîÏ≤≠ Ïã§Ìå®:", error);
      
      // ÏóêÎü¨ ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
      const errorQuestion = {
        ...newQuestion,
        error: true
      };

      const updatedList = questionList.length > 0
        ? [...questionList, errorQuestion]
        : [errorQuestion];

      setQuestionList(updatedList);
      
      // ÌòÑÏû¨ ÎåÄÌôî ÎòêÎäî ÏÉà ÎåÄÌôîÏùò ÏóêÎü¨ ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
      if (currentChatId) {
        updateCurrentChat(updatedList);
      } else if (newId) {
        setHistories(prev => prev.map(history =>
          history.id === newId
            ? { ...history, messages: updatedList }
            : history
        ));
      }
    }
  };

  // ÏÉàÎ°úÏö¥ ÎåÄÌôî ÏãúÏûë Ïãú ÌòÑÏû¨ ÎåÄÌôî Ï†ÄÏû•
  const saveCurrentChat = () => {
    if (questionList.length > 0) {
      // ÌòÑÏû¨ ÎåÄÌôîÍ∞Ä Ïù¥ÎØ∏ Ï†ÄÏû•ÎêòÏñ¥ ÏûàÎäîÏßÄ ÌôïÏù∏
      const isAlreadySaved = histories.some(history => 
        history.messages.length === questionList.length && 
        history.messages[0].question === questionList[0].question &&
        history.messages[history.messages.length - 1].question === 
        questionList[questionList.length - 1].question
      );

      if (!isAlreadySaved) {
        const newHistory: ChatHistory = {
          id: Date.now().toString(),
          title: questionList[0].question,
          messages: [...questionList],
          createdAt: new Date(),
        };
        setHistories(prev => [newHistory, ...prev]);
      }
    }
  };

  // ÏÉàÎ°úÏö¥ ÎåÄÌôî ÏãúÏûë
  const handleNewChat = () => {
    if (currentChatId) {
      saveCurrentChat();
    }
    setCurrentChatId(null);
    setQuestionList([]);
    setShowExampleList(true);
  };

  // Ï†ÄÏû•Îêú ÎåÄÌôî ÏÑ†ÌÉù
  const handleSelectHistory = (history: ChatHistory) => {
    if (currentChatId && currentChatId !== history.id) {
      saveCurrentChat();
    }
    setCurrentChatId(history.id);
    setQuestionList(history.messages);
    setShowExampleList(false);
  };

  // ÎåÄÌôî ÎÇ¥Ïö©Ïù¥ ÏóÖÎç∞Ïù¥Ìä∏Îê† ÎïåÎßàÎã§ histories ÏóÖÎç∞Ïù¥Ìä∏
  const updateCurrentChat = (newQuestionList: QAndA[]) => {
    if (currentChatId) {
      setHistories(prev => prev.map(history => 
        history.id === currentChatId
          ? {
              ...history,
              messages: newQuestionList,
              // ÎßàÏßÄÎßâ Î©îÏãúÏßÄÍ∞Ä Î≥ÄÍ≤ΩÎêú Í≤ΩÏö∞ÏóêÎßå title ÏóÖÎç∞Ïù¥Ìä∏
              title: history.messages[0].question
            }
          : history
      ));
    }
  };

  const handleAbort = () => {
    if (abortControllerRef.current) {
      abortControllerRef.current.abort();
      abortControllerRef.current = null;
    }
  };

  //Ïû¨ÏãúÎèÑ Î°úÏßÅ
  const handleRetry = async (index: number) => {
    const question = questionList[index].question;
    // if (!question) return;
    
    // setLoadingIndex(index);

    // try {
    //   const result = await mutation.mutateAsync({ query: question });
      
    //   const updatedList = questionList.map((qa, i) => 
    //     i === index 
    //       ? { 
    //           ...qa, 
    //           answer: result.answer, 
    //           context: result.context,
    //           imageNames: result.imageNames,
    //           fileNames: result.filenames,
    //           error: false 
    //         } 
    //       : qa
    //   );
      
    //   setQuestionList(updatedList);
    //   if (currentChatId) {
    //     updateCurrentChat(updatedList);
    //   }
    // } catch (error) {
    //   console.error("API ÏöîÏ≤≠ Ïã§Ìå®:", error);
    //   const updatedList = questionList.map((qa, i) => 
    //     i === index 
    //       ? { ...qa, error: true } 
    //       : qa
    //   );
    //   setQuestionList(updatedList);
    //   if (currentChatId) {
    //     updateCurrentChat(updatedList);
    //   }
    // } finally {
    //   setLoadingIndex(null);
    // }
  };

  // ÎåÄÌôî ÏÇ≠Ï†ú Ìï∏Îì§Îü¨
  const handleDeleteHistory = (id: string) => {
    setHistories(prev => prev.filter(history => history.id !== id));
    if (currentChatId === id) {
      setCurrentChatId(null);
      setQuestionList([]);
      setShowExampleList(true);
    }
  };

  return (
    <div className="flex flex-col min-h-screen bg-[var(--background)]">
      <ThemeToggle />
      <ChatHistoryMenu
        histories={histories}
        onSelectHistory={handleSelectHistory}
        onDeleteHistory={handleDeleteHistory}
        onNewChat={handleNewChat}
      />

      {showExampleList ? (
        <ExampleList onExampleClick={handleExampleClick} />
      ) : (
        <ChatList 
          questionList={questionList} 
          onRetry={handleRetry}
          isLoading={isPending}  // isLoadingÏùÄ mutationÏùò isPending ÏÉÅÌÉúÎ°ú Î≥ÄÍ≤Ω
          //isLoading={loadingIndex !== null}
          loadingIndex={loadingIndex}
        />
      )}

      <div className="w-full max-w-4xl mx-auto px-4">
        <SearchBar 
          ref={searchBarRef}
          handleSubmit={handleSubmit}
          domain={domain}
          setDomain={setDomain}
          isLoading={isPending}
          onAbort={handleAbort}
        />
      </div>
    </div>
  );
}

export default function Home() {
  return (
    <QueryClientProvider client={closedQueryClient}>
      <HomeContent />
    </QueryClientProvider>
  );
}